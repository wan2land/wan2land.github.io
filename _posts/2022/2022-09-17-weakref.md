---
layout: post
title: "WeakRefì™€ FinalizationRegistry ì´í•´í•˜ê¸°"
summary: "ES2021ì— ì¶”ê°€ëœ WeakRef, FinalizationRegistryë¥¼ ì˜ˆì œë¥¼ í†µí•´ ì´í•´í•´ë´…ì‹œë‹¤."
date: 2022-09-17 02:14:15 +09:00
tags: ["weakref", "javascript"]
thumbnail: "/images/2022/2022-09-17-weakref/thumbnail.png"
---

ì¼ì‹œì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë‹´ì•„ ë‘˜ ë•Œ, Mapì„ í™œìš©í•©ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì•„ì´ë””ë¥¼ í†µí•´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ì´ ìˆë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤.

```typescript
class UserFinder {

  findById(id: string) {
    return await this.db.findUserById(id)
  }
}
```

ë§¤ë²ˆ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ ë˜ë©´ ì„œë²„ì— ë§ì€ ë¶€í•˜ê°€ ê±¸ë¦¬ê²Œ ë©ë‹ˆë‹¤. ì´ë¥¼ ì™„í™”í•˜ê¸° ìœ„í•´ í•œë²ˆ ê°€ì ¸ì˜¨ ì‚¬ìš©ìëŠ” ìºì‹œì— ë‹´ì•„ë‘ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤. ê°„ë‹¨íˆ êµ¬í˜„í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ì´ ë©ë‹ˆë‹¤.

```typescript
class UserFinder {
  #cachedUsers = new Map()
  
  findById(id: string) {
    if (!this.#cachedUsers.has(id)) {
      const user = await this.db.findUserById(id)
      this.#cachedUsers.set(id, user)
    }
    return this.#cachedUsers.get(id)
  }
}
```

ë¬¼ë¡ .. ìœ„ ë¡œì§ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•˜ë‹¤ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜…

```
FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - process out of memory
```

ì‚¬ìš©ìê°€ ë§ìœ¼ë©´ ë§ì„ìˆ˜ë¡ `Map`(`#cachedUsers`)ì—ë„ ë§ì€ ê°ì²´ê°€ ìŒ“ì´ê²Œ ë©ë‹ˆë‹¤. ë”ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê°ì²´ëŠ” ì ì ˆíˆ ì‚­ì œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê°ì²´ëŠ” ê°€ë¹„ì§€ ì½œë ‰í„°(Garbage Collector)ì— ì˜í•´ ì‚­ì œë©ë‹ˆë‹¤. í•˜ì§€ë§Œ `Map`ì— ë‹´ê²¨ìˆëŠ” ê°ì²´ëŠ” ì°¸ì¡°ë¥¼ ìƒì§€ ì•Šê¸° ë•Œë¬¸ì— ê°€ë¹„ì§€ ì½œë ‰ì…˜(Garbage Collection)ì˜ ëŒ€ìƒì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ê°€ë¹„ì§€ ì½œë ‰ì…˜ í•˜ë©´ ê°€ì¥ ë¨¼ì € `WeakMap`ì´ ìƒê°ë‚©ë‹ˆë‹¤. `WeakMap`ì€ í‚¤ë¥¼ ê°ì²´ë¡œ ê°–ê³  í•´ë‹¹ í‚¤ê°€ ê°€ë¹„ì§€ ì½œë ‰í„°ì˜ ëŒ€ìƒì´ ë  ë•Œ í‚¤ì— í•´ë‹¹í•˜ëŠ” ê°’ì´ ì‚­ì œë˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

```typescript
const user = { id: 1 }

const map = new WeakMap()

map.set(user, { username: 'wan2land' })

map.get(user) // { username: 'wan2land' }
map.get({ id: 1 }) // undefined
```

`WeakMap`ì€ ê°’(`{ id: 1 }`)ì´ ê°™ì•„ë„ ê°ì²´ê°€ ë‹¤ë¥´ë©´ ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì²˜ìŒì— ì‘ì„±í•œ `UserFinder`ì˜ˆì œì—ì„œ ì‚¬ìš©í•˜ê¸° ì ì ˆí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë” ìì„¸í•œ WeakMapì˜ ë‚´ìš©ì€ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

[The Modern JavaScript Tutorial - WeakMapì„ ì‚¬ìš©í•œ ìºì‹±ì˜ ì˜ˆì‹œ](https://ko.javascript.info/weakmap-weakset#ref-2329)

`WeakMap`ì€ í‚¤ë¥¼ ê°ì²´ë¡œ ê°€ì§‘ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ìŠ¤ì¹¼ë¼ê°’(`String`, `Number`, `Boolean` ...)ì„ í‚¤ë¡œ ê°–ëŠ” `WeakMap`ê³¼ ìœ ì‚¬í•œ ê°€ë¹„ì§€ ì½œë ‰í„°ì˜ ëŒ€ìƒì´ ë˜ëŠ” ~~ì–´ë©”ì´ì§•í•œ(?)~~ ë¬´ì–¸ê°€(?!)ë¥¼ ì›í•©ë‹ˆë‹¤. ì´ë•Œ ES2021ì— ì¶”ê°€ëœ `WeakRef`ë¥¼ ì´ìš©í•´ë´…ì‹œë‹¤. :-)

`WeakRef`ëŠ” ì°¸ì¡°ëœ ê°ì²´ê°€ ê°€ë¹„ì§€ ì½œë ‰í„°ì˜ ëŒ€ìƒì´ ë  ë•Œ, ê·¸ ë‚´ë¶€ì˜ ê°ì²´ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤. `WeakMap`ì˜ `deref()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©´, ê°€ë¹„ì§€ ì½œë ‰ì…˜ ì „ì—ëŠ” í¬í•¨í•˜ê³  ìˆëŠ” ë‚´ë¶€ì˜ ê°’ì´ ì •ìƒì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. ê°€ë¹„ì§€ ì½œë ‰ì…˜ ë’¤ì—ëŠ” ë‚´ë¶€ì˜ ê°’ì´ ì‚¬ë¼ì ¸ì„œ `undefined` ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¥¼ ì½”ë“œë¡œ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```typescript
let user = { id: 1 }
const ref = new WeakRef(user)

ref.deref() // { id: 1 }

user = null // ê°€ë¹„ì§€ ì½œë ‰ì…˜ ë°œìƒ! (..ì‹¤ì œë¡œëŠ” í™˜ê²½ì— ë”°ë¼ ì¼ì–´ë‚˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤..)

ref.deref() // undefined
```

ì´ì œ `WeakRef`ë¥¼ í™œìš©í•´ì„œ `UserFinder`ë¥¼ ê°œì„ í•´ë´…ì‹œë‹¤.

```typescript
class UserFinder {
  #cachedUsers = new Map()
  
  findById(id: string) {
    if (!this.#cachedUsers.has(id)) {
      const user = await this.db.findUserById(id)
      this.#cachedUsers.set(id, new WeakRef(user)) // WeakRef!
    }
    return this.#cachedUsers.get(id).deref()
  }
}
```

 ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœ ê²ƒ ê°™ì§€ë§Œ, `WeakRef` ìì²´ë¥¼ ê°€ì§€ê³  ìˆëŠ” `Map`ì€ ì—¬ì „íˆ ì“¸ëª¨ì—†ëŠ” `WeakRef`ê°ì²´ë¡œ ê°€ë“í•©ë‹ˆë‹¤. `WeakRef` ë‚´ë¶€ì˜ ê°ì²´ê°€ ì‚¬ë¼ì§ˆ ë•Œ, `Map`ì—ì„œ `WeakRef` ê°ì²´ë„ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤. ì´ ë•Œ `FinalizationRegistry`ë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. `FinalizationRegistry`ëŠ” ë“±ë¡ëœ ê°ì²´ê°€ ê°€ë¹„ì§€ ì»¬ë ˆì…˜ì˜ ëŒ€ìƒì´ ë  ë•Œ í•¨ê»˜ ë“±ë¡ëœ ê°’ì„ ì´ë²¤íŠ¸ë¡œ ë¶ˆëŸ¬ì¤ë‹ˆë‹¤.

```typescript

const registry = new FinalizationRegistry((heldValue) => {
  console.log(heldValue)
})

let user = { id: 2 }

registry.register(user, 'id is 2')

user = null // ê°€ë¹„ì§€ ì½œë ‰ì…˜ ë°œìƒ! (..ì‹¤ì œë¡œëŠ” í™˜ê²½ì— ë”°ë¼ ì¼ì–´ë‚˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤..)
// ì—¬ê¸°ì„œ ìœ„ í•¸ë“¤ëŸ¬ì˜ console.log("id is 2") í˜¸ì¶œ!
```

ì´ì œ `FinalizationRegistry`ë¥¼ ì´ìš©í•´ì„œ ì½”ë“œë¥¼ ë³´ì™„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë©ë‹ˆë‹¤.

```typescript
class UserFinder {
  #cachedUsers = new Map()
  #registry
  
  constructor() {
    this.#registry = new FinalizationRegistry((id) => {
      this.#cachedUsers.delete(id)
    })
  }
  
  findById(id: string) {
    if (!this.#cachedUsers.has(id)) {
      const user = await this.db.findUserById(id)
      this.#cachedUsers.set(id, new WeakRef(user))
      this.#registry.register(user, id)
    }
    return this.#cachedUsers.get(id).deref()
  }
}
```

ê¸°íšì´ ì¶”ê°€ë˜ì–´ `UserFinder` ë§ê³  `ArticleFinder`ì—ì„œë„ êµ¬í˜„í•´ì•¼í•©ë‹ˆë‹¤. ê·¸ ë‹¤ìŒì—ëŠ” `CommentFinder`ì—ë„ ì ìš©í•´ì•¼ í•œë‹¤ê³  í•©ë‹ˆë‹¤.... ë§¤ë²ˆ ìœ„ì™€ ê°™ì€ ì½”ë“œë¥¼ ë°˜ë³µí•´ì„œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ì¢€ ê·€ì°®ìŠµë‹ˆë‹¤. ğŸ˜…

ë‹¤ìŒê³¼ ê°™ì´ `InvertedWeakMap` í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. **(ì´ê²Œ ì ¤ ì¤‘ìš”!!)**

```typescript
class InvertedWeakMap<K extends string | symbol, V extends object> {
  _map = new Map<K, WeakRef<V>>()
  _registry: FinalizationRegistry<K>

  constructor() {
    this._registry = new FinalizationRegistry<K>((key) => {
      this._map.delete(key)
    })
  }

  set(key: K, value: V) {
    this._map.set(key, new WeakRef(value))
    this._registry.register(value, key)
  }

  get(key: K): V | undefined {
    const ref = this._map.get(key)
    if (ref) {
      return ref.deref()
    }
  }

  has(key: K): boolean {
    return this._map.has(key) && this.get(key) !== undefined
  }
}
```

ì´ì œ `UserFinder`ë¥¼ ê°œì„ í•´ë´…ì‹œë‹¤.

```typescript
class UserFinder {
  #cachedUsers = new InvertedWeakMap()
  
  findById(id: string) {
    if (!this.#cachedUsers.has(id)) {
      const user = await this.db.findUserById(id)
      this.#cachedUsers.set(id, user)
    }
    return this.#cachedUsers.get(id)
  }
}
```

ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œ ìºì‹±ì€ ë ˆë””ìŠ¤(Redis)ì™€ ê°™ì€ Key-Value Storageë¥¼ ì´ìš©í•©ë‹ˆë‹¤. ìœ„ ì˜ˆì‹œëŠ” ì–´ë””ê¹Œì§€ë‚˜ `WeakRef`ì™€ `FinalizationRegistry`ì˜ ì´í•´ë¥¼ ìœ„í•´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ë¹„ì§€ ì½œë ‰ì…˜ì˜ íƒ€ì´ë°ì´ ì˜ˆì¸¡ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— í™•ì‹¤í•œ ì´í•´ ì—†ì´ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìŒ.. ì–¸ì  ê°€ ORMê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ íŠ¸ëœì­ì…˜ ìºì‹œ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ ì•Šì„ê¹Œ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì˜ˆì¸¡í•´ë´…ë‹ˆë‹¤. ğŸ™‚

## ì°¸ê³ 

- [MDN Web Docs - WeakRef](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakRef)
- [MDN Web Docs - FinalizationRegistry](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry)
- [TC39 - WeakRefs TC39 proposal](https://github.com/tc39/proposal-weakrefs)
